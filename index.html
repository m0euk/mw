
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Radio Log Embed (Lazy-Load Audio)</title>

<style>
  /* ---------- Base (mobile-first) ---------- */
  :root {
    --page-padding: 12px;
    --container-max: 1200px;
  }

  html, body {
    height: 100%;
  }

  body {
    font-family: Arial, sans-serif;
    margin: 0;
    line-height: 1.5;
    padding-top: 55px;
    font-size: 14px;
    background-color: #fff;
    /* allow scrolling if content is taller than viewport (do NOT hide x-overflow) */
  }

  .header-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    padding: 10px var(--page-padding);
    z-index: 1000;
  }
  .header-bar h1 { margin: 0; font-size: 1.2rem; }

  #jump-container {
    padding: 10px var(--page-padding) 0;
    text-align: right;
    width: 100%;
    margin: 0 auto;
    box-sizing: border-box;
  }

  #jump-to-latest {
    display: none;
    background-color: #007bff;
    color: white;
    border: none;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 0.9em;
    text-decoration: none;
  }

  #main-content {
    display: flex;
    justify-content: center;
    padding: 12px var(--page-padding) 24px;
    box-sizing: border-box;
  }

  /* Container that holds the table and allows internal horizontal scroll (if needed) */
  #log-container {
    width: 100%;
    max-width: var(--container-max);
    box-sizing: border-box;
    margin: 0 auto;
    padding: 0;
  }

  /* Make the table responsive inside the container */
  .table-wrap {
    width: 100%;
    overflow-x: auto;        /* scroll inside this element (not the whole page) */
    -webkit-overflow-scrolling: touch;
    box-sizing: border-box;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    min-width: 700px;        /* allow a comfortable layout on desktop */
    table-layout: auto;
    font-size: 0.95rem;
  }

  th, td {
    border: 1px solid #ddd;
    padding: 6px 8px;
    text-align: left;
    vertical-align: top;
    word-wrap: break-word;
    word-break: break-word;
  }

  th { background-color: #f2f2f2; font-weight: bold; }
  tr:nth-child(even) { background-color: #f9f9f9; }

  .audio-player-cell { min-width: 180px; }
  audio { width: 100%; max-width: 100%; margin-top: 4px; }

  .load-btn {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 4px 8px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 0.85em;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .spinner {
    width: 14px; height: 14px;
    border: 2px solid #fff;
    border-top: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ---------- Desktop tweaks ---------- */
  @media (min-width: 1025px) {
    .header-bar h1 { font-size: 1.4rem; }
    #jump-container { max-width: 75%; }      /* centered small panel on very large screens */
    #log-container { max-width: 1100px; }
    table { min-width: 800px; }
  }

  /* ---------- Tablet ---------- */
  @media (min-width: 769px) and (max-width: 1024px) {
    #jump-container { max-width: 90%; }
    #log-container { max-width: 1000px; }
    table { min-width: 760px; }
  }

  /* ---------- Mobile: convert table to stacked cards ---------- */
  @media (max-width: 768px) {
    /* hide native table layout and show stacked blocks */
    table, thead, tbody, th, td, tr {
      display: block;
    }

    thead {
      display: none; /* hide header row for stacked view */
    }

    tr {
      margin: 0 0 12px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    }

    td {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 6px 8px;
      border: none;
      border-bottom: 1px solid #eee;
      font-size: 0.95rem;
    }

    td:last-child { border-bottom: none; }

    /* label (column name) */
    td .label {
      flex: 0 0 40%;
      max-width: 40%;
      font-weight: 600;
      padding-right: 8px;
      color: #333;
    }

    td .value {
      flex: 1 1 60%;
      max-width: 60%;
      word-wrap: break-word;
      text-align: right;
    }

    .audio-player-cell .value {
      text-align: left;
    }

    /* tighten spacing on very small phones */
    body { font-size: 13px; padding-top: 50px; }
    .header-bar h1 { font-size: 1.05rem; }
  }
</style>



  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="header-bar">
    <h1>Radio Log Embed</h1>
  </div>

  <div id="jump-container">
    <a href="#latest-entry" id="jump-to-latest">Jump to Latest Entry â†“</a>
  </div>

  <div id="main-content">
    <div id="log-container">
      Loading log data...
    </div>
  </div>

  <script>
    // CONFIG
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6Q67Mj9AV5cIsfi3uoYqZIzJbWg3woVNurwmnm326EGO9xy_c521nMiaKo7yQVXlWu_Itvi5dNCps/pub?gid=1343487192&single=true&output=csv';
    const AUDIO_LINK_COLUMN_NAME = 'GD';
    const APPS_SCRIPT_BASE = "https://script.google.com/macros/s/AKfycbxImPQKXzR6cWU-y6udoA3sZCtLijjyZ-xg6dbGuHdNN-_QugT369RSWnBFEpuDgZa9/exec"; // your deployed script

    document.addEventListener('DOMContentLoaded', () => {
      fetchLogData(CSV_URL);
    });

    // Get Base64 audio data from Apps Script
    async function fetchDriveAudio(fileId) {
      const apiUrl = `${APPS_SCRIPT_BASE}?id=${fileId}`;
      try {
        const res = await fetch(apiUrl);
        const json = await res.json();
        if (json.error) throw new Error(json.error);
        return `data:${json.mimeType};base64,${json.data}`;
      } catch (err) {
        console.error("Error fetching Drive audio:", err);
        return null;
      }
    }

    // Extract File ID from Drive link
    function extractFileId(url) {
      const match = url.match(/drive\.google\.com\/(?:file\/d\/|open\?id=|uc\?id=)([a-zA-Z0-9_-]+)/);
      return match ? match[1] : null;
    }

    // Show/hide jump button
    function showJumpButton(isVisible) {
      const button = document.getElementById('jump-to-latest');
      if (button) button.style.display = isVisible ? 'inline-block' : 'none';
    }

    async function fetchLogData(url) {
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const csvText = await response.text();

        Papa.parse(csvText, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: results => renderTable(results.data, results.meta.fields)
        });
      } catch (error) {
        console.error("Could not fetch the log data: ", error);
        document.getElementById('log-container').innerHTML =
          `<p style="color: red;">Failed to load data. Error: ${error.message}</p>`;
      }
    }

    function renderTable(data, headers) {
      const filtered = data.filter(row => row && Object.values(row).some(v => v !== null && v !== ""));
      if (filtered.length === 0) {
        document.getElementById('log-container').innerHTML = `<p>No data found in the sheet.</p>`;
        showJumpButton(false);
        return;
      }

      const table = document.createElement('table');
      const thead = table.createTHead();
      const tbody = table.createTBody();

      // Header
      const headerRow = thead.insertRow();
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        if (h === AUDIO_LINK_COLUMN_NAME) th.classList.add('audio-player-cell');
        headerRow.appendChild(th);
      });

      // Body
      filtered.forEach((row, i) => {
        const tr = tbody.insertRow();
        if (i === filtered.length - 1) tr.id = 'latest-entry';

        headers.forEach(h => {
          const td = tr.insertCell();
          const val = row[h];

          if (h === AUDIO_LINK_COLUMN_NAME && typeof val === 'string' && val.startsWith('http')) {
            const fileId = extractFileId(val);
            if (fileId) {
              const btn = document.createElement('button');
              btn.textContent = "Load & Play";
              btn.className = "load-btn";
              td.appendChild(btn);

              btn.addEventListener('click', async () => {
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner"></span> Loading...`;

                const audioLink = await fetchDriveAudio(fileId);
                if (audioLink) {
                  const audio = document.createElement('audio');
                  audio.controls = true;
                  audio.src = audioLink;
                  td.innerHTML = "";
                  td.appendChild(audio);
                  audio.play();
                } else {
                  btn.textContent = "Failed";
                  btn.disabled = false;
                }
              });
            } else {
              td.textContent = "Invalid link";
            }
          } else if (typeof val === 'string' && val.startsWith('http')) {
            const a = document.createElement('a');
            a.href = val;
            a.textContent = val.length > 50 ? val.substring(0, 47) + '...' : val;
            a.target = '_blank';
            td.appendChild(a);
          } else {
            td.textContent = val;
          }
        });
      });

      const container = document.getElementById('log-container');
      container.innerHTML = '';
      container.appendChild(table);
showJumpButton(true);

/* --- Make table rows into accessible 'card' blocks on small screens ---
   This sets each <td> to contain two spans: a .label (column name) and .value (cell content).
   Works after the table is generated.
*/
function enableMobileStackedTable(tableEl) {
  // retrieve headers in order
  const headers = Array.from(tableEl.querySelectorAll('thead th')).map(h => h.textContent.trim());

  // if headers are missing (some browsers or our stacked mode), try fallback by reading first row's cells count
  const rows = tableEl.querySelectorAll('tbody tr');
  rows.forEach(row => {
    const cells = Array.from(row.children);
    cells.forEach((cell, idx) => {
      // skip if already wrapped (avoid double-wrapping when re-rendering)
      if (cell.querySelector('.label')) return;

      // create label & value containers
      const labelSpan = document.createElement('span');
      labelSpan.className = 'label';
      labelSpan.textContent = headers[idx] || `Column ${idx+1}`;

      const valueSpan = document.createElement('span');
      valueSpan.className = 'value';

      // move existing cell content into valueSpan
      while (cell.firstChild) valueSpan.appendChild(cell.firstChild);

      // clear cell and append label + value
      cell.appendChild(labelSpan);
      cell.appendChild(valueSpan);
    });
  });
}

// call once now (table is present)
enableMobileStackedTable(table);

    }
  </script>
</body>
</html>
