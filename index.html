<script>
    // 1. CONFIGURATION
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6Q67Mj9AV5cIsfi3uoYqZIzJbWg3woVNurwmnm326EGO9xy_c521nMiaKo7yQVXlWu_Itvi5dNCps/pub?gid=1343487192&single=true&output=csv';
    const AUDIO_LINK_COLUMN_NAME = 'GD';

    document.addEventListener('DOMContentLoaded', () => {
        fetchLogData(CSV_URL);
    });
 
    async function fetchLogData(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const csvText = await response.text();
            
            // Use PapaParse to parse the CSV data
            Papa.parse(csvText, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    renderTable(results.data, results.meta.fields);
                }
            });

        } catch (error) {
            console.error("Could not fetch the log data: ", error);
            document.getElementById('log-container').innerHTML = `<p style="color: red;">Failed to load data. Please check the URL and ensure the sheet is published correctly. Error: ${error.message}</p>`;
        }
    }

    function renderTable(data, headers) {
        // ⭐ NEW LINE ADDED HERE: Reverse the data array so the last (newest) row goes to the top
        data.reverse(); 

        const table = document.createElement('table');
        const thead = table.createTHead();
        const tbody = table.createTBody();

        // Create Table Header
        let headerRow = thead.insertRow();
        headers.forEach(header => {
            let th = document.createElement('th');
            th.textContent = header;
            if (header === AUDIO_LINK_COLUMN_NAME) {
                th.classList.add('audio-player-cell');
            }
            headerRow.appendChild(th);
        });

        // Populate Table Body
        data.forEach(row => {
            let tr = tbody.insertRow();
            headers.forEach(header => {
                let td = tr.insertCell();
                let cellValue = row[header];

                // 1. Audio Link Column Logic
                if (header === AUDIO_LINK_COLUMN_NAME && cellValue && typeof cellValue === 'string' && cellValue.startsWith('http')) {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = cellValue;
                    td.appendChild(audio);
                    td.classList.add('audio-player-cell');
                    return;
                }
                
                // 2. General Link Logic (for any other URL)
                else if (typeof cellValue === 'string' && cellValue.startsWith('http')) {
                    const a = document.createElement('a');
                    a.href = cellValue;
                    a.textContent = cellValue.length > 50 ? cellValue.substring(0, 47) + '...' : cellValue;
                    a.target = '_blank';
                    td.appendChild(a);
                }
                
                // 3. Regular text content
                else {
                    td.textContent = cellValue;
                }
            });
        });

        document.getElementById('log-container').innerHTML = '';
        document.getElementById('log-container').appendChild(table);
    }
</script>
